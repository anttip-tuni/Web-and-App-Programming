<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body{
            min-height: 90vh;
        }

        .circle{
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: crimson;
            position: absolute;
            box-sizing: border-box;
            box-shadow: #0000005c 2px 2px 10px;
        }

        div#header {
            display: grid;
            grid-template-columns: 3fr repeat(9,1fr);

        }

        

        .uielem {
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .plusButton {
            font-size: 4rem;
            font-weight: bolder;
            background-color: darkgrey;
            width: 5rem;
            height: 5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-left: 1rem;
        }

        .selected{
            border: 3px dashed darkblue;
        }

       .circle {
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
}


.textareawrap {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 90%;
    height: 90%;
}

.line {
    height: 3px;
    background-color: chocolate;
    transform-origin: 0 100%;
}

/* CSS */
.button {
    appearance: button;
    background-color: #1899D6;
    border: solid transparent;
    border-radius: 16px;
    border-width: 0 0 4px;
    box-sizing: border-box;
    color: #FFFFFF;
    cursor: pointer;
    display: block;
    font-family: din-round,sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: .8px;
    line-height: 20px;
    margin: 0;
    outline: none;
    overflow: visible;
    padding: 10px 13px;
    text-align: center;
    text-transform: uppercase;
    touch-action: manipulation;
    transform: translateZ(0);
    transition: filter .2s;
    user-select: none;
    -webkit-user-select: none;
    white-space: nowrap;
}

.button:after {
  background-clip: padding-box;
  background-color: #1CB0F6;
  border: solid transparent;
  border-radius: 16px;
  border-width: 0 0 4px;
  bottom: -4px;
  content: "";
  left: 0;
  position: absolute;
  right: 0;
  top: 0;
  z-index: -1;
}

.button:main,
.button:focus {
  user-select: auto;
}

.button:hover:not(:disabled) {
  filter: brightness(1.1);
  -webkit-filter: brightness(1.1);
}

.button:disabled {
  cursor: auto;
}



    </style>

    <link rel="stylesheet" href="jquery-ui.css">
</head>
<body>

    <div id="header">
        
        <div class="uielem"><h1>Mind Mapper</h1></div>
        <div class="uielem"><div class="plusButton">+</div></div>
        <div class="uielem"><input type="color" id="color"></div>
        <div class="uielem"><input type="range" min="50" max="1500" value="200" id="circlesize"></div>
        <div class="uielem"><img id="clonebrush" src="iconmonstr-paintbrush-3-64.png" alt=""></div>
        <div class="uielem"><img id="eraser" src="iconmonstr-eraser-1-48.png" alt=""></div>
        <div class="uielem"></div>
        <div class="uielem"></div>
        <div class="uielem"></div>
        <div class="uielem"><button id="deleteSave" class="button">Delete save</button></div>

        
        
        
        
    
    </div>

    <div class="circle" id="c0">
        <div class="textareawrap">
            <div class="textarea" contenteditable="false">Change Me</div>
        </div>
    </div>

    <script src="jquery-3.6.3.js"></script>
    <script src="jquery-ui.min.js"></script>

    <script>

        /*
        TO DO LIST:
        -Would be nice to control drag circles to duplicate them with the same properties that they already have and also connecting to the same nodes
        -deleting localstorage saves
        -delete circles with an eraser tool and or by selecting it and hitting delete
        -saving and opening files
        -sizing also the texts
        -undo and redo
        X remove all selections when clicking on an empty spot
        
        */

    let newCircleID = 1;
    let eraseMode = false;
    let cloneMode = false;

    $(document).ready(function(){
        loadFromLocalStorage();
    })



 /*    let ctrlPressed = false;
    let dragging = false;

        $(document).keydown(function (event) {
            if (event.which === 17) { // 17 is the keycode for Ctrl key
                ctrlPressed = true;
            }
        });

        $(document).keyup(function (event) {
            if (event.which === 17) {
                ctrlPressed = false;
            }
        }); */


     //DRAGGABLE OPTIONS OBJECT:

        draggableOptions = {
                
                        start: function (event, ui) {
                            if (event.ctrlKey) {
                                $(this).addClass('cloned');
                                $(this).data('cloned', $(this).clone().removeClass('cloned'));
                                $(this).data('originalCircle', $(this).attr('id'));
                                console.log('id: ' + $(this).attr('id'));
                            } else { //no ctrl
                                $(this).removeClass('cloned');
                            }
                        },
                        drag: function (event, ui) {
                            updateLines(this);
                        },
                        stop: function (event, ui) {
                            if ($(this).hasClass('cloned')) {
                                let cloned = $(this).data('cloned').removeClass('ui-draggable-dragging');
                                $('body').append(cloned);
                                cloned.css({
                                    position: 'absolute',
                                    left: ui.offset.left,
                                    top: ui.offset.top
                                });
                                cloned.attr('id', 'c' + newCircleID);
                                newCircleID++;
                                cloned.draggable(draggableOptions);
                                $(this).data('cloned', cloned);

                                //scoping

                                let otherCircleID;

                                //get the id of the circle from which the clone was made
                                let originalCircleID = $(this).data('originalCircle');

                                //check if there are lines with the id of the original one:
                                let allConnectedLines = $(`.line[data-circle1="${originalCircleID}"],.line[data-circle2="${originalCircleID}"]`);
                                //TO DO: find the other end of the line and create a line between that circle and the cloned circle 

                                if (allConnectedLines.length > 0){

                                    allConnectedLines.each(function (index, line) {
                                        let lineCircleConnect1 = $(line).data('circle1');
                                        let lineCircleConnect2 = $(line).data('circle2');
                                        
                                        //if the id matches with lineCircleConnect1 then give us lenCircleCOnnect2, else give us lineCircleConnect1 
                                        otherCircleID = (lineCircleConnect1 == originalCircleID) ? lineCircleConnect2 : lineCircleConnect1;
                                        //console.log(otherCircleID);
                                    });

                                    //select the circle based on the other end of the line
                                    let theOtherCircle = $('#' + otherCircleID);


                                    //now draw the line:

                                    let selectedCircle = $(cloned);

                                    let selectedCircleID = selectedCircle.attr('id');
                                    //let clickedCircleID = otherCircleID;

                                    console.log('selectedCircleID ' + selectedCircleID + ' otherCircleID ' + otherCircleID);

                                    let selectedCircleWidth = selectedCircle[0].getBoundingClientRect().width;
                                    let theOtherCircleWidth = $(theOtherCircle)[0].getBoundingClientRect().width;

                                    let x1pos = selectedCircle[0].getBoundingClientRect().left + selectedCircleWidth / 2; //[0] take the first element from the jQuery object and then get it's x coordinate
                                    let y1pos = selectedCircle[0].getBoundingClientRect().top + selectedCircleWidth / 2;
                                    let x2pos = $(this)[0].getBoundingClientRect().left + theOtherCircleWidth / 2;
                                    let y2pos = $(this)[0].getBoundingClientRect().top + theOtherCircleWidth / 2;

                                    console.log('creating a line now, this is: ' + this);

                                    createLine(x1pos, y1pos, x2pos, y2pos, selectedCircleID, otherCircleID);
                                    updateLines(cloned);


                                }
                                

                                


                                saveToLocalStorage();
                            } else {
                                saveToLocalStorage();
                            }
                        },
                        helper: function(event) {
                            if (event.ctrlKey) {
                                return $(this).clone().css('opacity', 1);
                            } else {
                                return $(this);
                            }
                        }
             }
            


    //DETECT DOUBLE CLICKS ON THE TEXTAREA DIV
    $('body').on('dblclick', '.textarea', function(){
        $(this).attr('contenteditable', 'true').focus();

        let myCircle = $(this).closest('.circle');

        if (myCircle.data('ui-draggable')){
             $(myCircle).draggable('destroy');
        }

    })

    //CHEK IF THE TEXT AREA STOPS BEING IN FOCUS
    $('body').on('blur', '.textarea', function(){

        $(this).attr('contenteditable', 'false');
        $(this).closest('.circle').draggable(draggableOptions);

        saveToLocalStorage();
    })

   
    

            

    $('body').on('mousedown', '.textarea', function(event){
        console.log('mousedown on .textarea');
        event.stopPropagation();
    })

    //CREATE A NEW CIRCLE BY CLICKING ON THE PLUS BUTTON:

      $('.plusButton').click(function(){
        let myNewCircle = $('<div class="circle"><div class="textareawrap"><div class="textarea" contenteditable="false">Change Me</div></div ></div>');
        myNewCircle.attr('id', 'c'+ newCircleID);
        newCircleID++; //grow the variable by one every time a circle is created
         $(myNewCircle).animate({
              width: '20vw',
              height: '20vw'
          }, 2000);
        $('body').append(myNewCircle);
         $(myNewCircle).draggable(draggableOptions);
         saveToLocalStorage();
      })
       

        $('.circle').animate({
            width: '20vw',
            height: '20vw'
        },2000);

         $('.circle').draggable(draggableOptions);

       
       //ADD OR REMOVE THE SELECTED CLASS OF A CIRCLE WHEN ITS CLICKED
        $('body').on('click', '.circle', function(){
            
            //check for special modes like eraseMode and TO DO: cloneMode

            if (!eraseMode){
                $(this).toggleClass('selected');
            } else { //erasemode

                deleteElement(this);
                
            }
            
            

        });

        //remove selection from circles if just the body or an empty area was clicked
        $('body').click(function(e){
            if ($(e.target).is('body')){
                console.log('should remove selections now');
                 $('.circle').removeClass('selected');
                 eraseMode = false;
                 changeMode();
            }
        })

        //DETECT A SHIFT CLICK

        $('body').on('mouseup', '.circle', function(event){

            if (event.shiftKey){
                console.log('you clicked on a circle while holding down shift');
                let selectedCircle = $('.selected');

                let selectedCircleID = selectedCircle.attr('id');
                let clickedCircleID = $(this).attr('id');

                console.log('selectedCircleID ' + selectedCircleID + ' clickedCircleID ' + clickedCircleID);

                let selectedCircleWidth = selectedCircle[0].getBoundingClientRect().width;
                let clickedCircleWidth = $(this)[0].getBoundingClientRect().width;

                let x1pos = selectedCircle[0].getBoundingClientRect().left + selectedCircleWidth/2; //[0] take the first element from the jQuery object and then get it's x coordinate
                let y1pos = selectedCircle[0].getBoundingClientRect().top + clickedCircleWidth/2;
                let x2pos = $(this)[0].getBoundingClientRect().left + clickedCircleWidth/2;
                let y2pos = $(this)[0].getBoundingClientRect().top + clickedCircleWidth / 2;

                console.log('creating a line now, this is: ' + this);

                createLine(x1pos, y1pos, x2pos, y2pos, selectedCircleID, clickedCircleID);
                saveToLocalStorage();

            }

        })
 
            //CREATE A LINE BETWEEN TWO ELEMENTS (FOUR COORDINATES):
            function createLine(x1, y1, x2, y2, selectedCircleID, clickedCircleID){

                let length = Math.sqrt(((x1 - x2) * (x1 - x2)) + ((y1 - y2) * (y1 - y2)));
                let angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                let transform = 'rotate(' + angle + 'deg)';

                offsetX = (x1 > x2) ? x2 : x1;
                offsetY = (y1 > y2) ? y2 : y1;

                let line = $('<div>')
                            .prependTo('body')
                            .addClass('line')
                            .css({
                                'position': 'absolute',
                                'transform': transform
                            })
                            .width(length)
                            .offset({
                                left: offsetX,
                                top: offsetY
                            })
                            .attr("data-circle1", selectedCircleID)
                            .attr("data-circle2", clickedCircleID)


            }

            //UPDATE THE LINES WHEN A CIRCLE IS MOVED

            function updateLines(circle){

                let allConnectedLines = getConnectedLines(circle);

                allConnectedLines.each(function (index, line){

                    let lineCircleConnect1 = $(line).data('circle1'); //get the circle ids from the lines
                    let lineCircleConnect2 = $(line).data('circle2');

                    let circle1 = $('#' + lineCircleConnect1); //select the circle from dom
                    let circle2 = $('#' + lineCircleConnect2); //select the circle from dom

                    let x1Pos = circle1[0].getBoundingClientRect().left + circle1[0].getBoundingClientRect().width / 2;
                    let y1Pos = circle1[0].getBoundingClientRect().top + circle1[0].getBoundingClientRect().height / 2;
                    let x2Pos = circle2[0].getBoundingClientRect().left + circle2[0].getBoundingClientRect().width / 2;
                    let y2Pos = circle2[0].getBoundingClientRect().top + circle2[0].getBoundingClientRect().height / 2;

                    $(this).remove();

                    createLine(x1Pos, y1Pos, x2Pos, y2Pos, circle1.attr('id'), circle2.attr('id'));

                })
            } //update lines


            //CHANGE THE COLOR OF THE SELECTED CIRCLES

            $('body').on('input', '#color', function(){
                //console.log($(this).val());

                $('.selected').css("background-color", $(this).val());
                saveToLocalStorage();

            })
            
            //CHANGE THE SIZE OF THE CIRCLES

            $("#circlesize").on('change input', function(){
                const scaleValueFromSlider = $(this).val();
                //console.log('scaleValueFromSlider: ' + scaleValueFromSlider);
                $('.selected').each(function() {

                    const currentWidth = $(this).outerWidth();
                    //console.log(currentWidth);
                    $(this).css({'width': scaleValueFromSlider, 'height': scaleValueFromSlider});

                    const currentPosition = $(this).position();

                    let newX = currentPosition.left - (scaleValueFromSlider - currentWidth) / 2;
                    let newY = currentPosition.top - (scaleValueFromSlider - currentWidth) / 2;

                    $(this).css({left: newX, top: newY});
                   



                })
                saveToLocalStorage();
            })

            //GET THE NECESSARY DATA FROM EVERY ELEMENT OF THE MIND MAP
            function extractData(){

                //loop through each circle and push the needed info as an object into an array
                const circlesData = [];
                
                $('.circle').each(function(){
                        const circleID = $(this).attr('id');
                        const circleText = $(this).find('.textarea').text();
                        const circleColor = $(this).css('background-color');
                        const circlePos = $(this).position();
                        const circleWidth = $(this).width();
                        circlesData.push({
                            id: circleID,
                            text: circleText,
                            color: circleColor,
                            position: circlePos,
                            width: circleWidth
                        })

                }) //end circle each

                //loop through each line
                const linesData = [];
                $('.line').each(function(){
                    const lineData = {
                        circle1: $(this).data('circle1'),
                        circle2: $(this).data('circle2')
                    };

                    linesData.push(lineData);

                });

                return {
                    circles: circlesData,
                    lines: linesData
                }

            } //end extract data

            //SAVE TO STORAGE:
            function saveToLocalStorage(){
                console.log('Should store to local storage now');
                const myData = extractData(); //store the return value of extractData into a variable called myData
                const jsonData = JSON.stringify(myData);
                localStorage.setItem('mindMapperData', jsonData);
                localStorage.setItem('latestID', newCircleID);
            }

            //GET THE CIRCLES AND LINES BACK FROM LOCAL STORAGE

            function loadFromLocalStorage(){
                const jsonData = localStorage.getItem('mindMapperData');
                if (!jsonData) return; //quit/exit the function early if there is no data yet

                const theLatestID = localStorage.getItem('latestID');
                if (!theLatestID) return;

                newCircleID = theLatestID;


                const myData = JSON.parse(jsonData);

                //Clear existing elements
                $('.circle').remove();
                $('.line').remove();

                myData.circles.forEach(circleData => {
                    //create a new html element for each circle
                    const circle = $(`
                    <div class="circle">
                        <div class="textareawrap">
                             <div class="textarea" contenteditable="false">Change Me</div>
                        </div>
                    </div>
                    `);

                    circle.attr('id', circleData.id);
                    circle.find('.textarea').text(circleData.text);
                    circle.css('background-color', circleData.color);
                    circle.css('left', circleData.position.left + 'px');
                    circle.css('top', circleData.position.top + 'px');
                    circle.width(circleData.width);
                    circle.height(circleData.width);
                    $('body').append(circle);
                    $(circle).draggable(draggableOptions);
                }) //end circles for each

                // Recreate lines
                myData.lines.forEach(lineData => {
                    const circle1 = $('#' + lineData.circle1);
                    const circle2 = $('#' + lineData.circle2);

                    const x1Pos = circle1[0].getBoundingClientRect().left + circle1[0].getBoundingClientRect().width / 2;
                    const y1Pos = circle1[0].getBoundingClientRect().top + circle1[0].getBoundingClientRect().height / 2;
                    const x2Pos = circle2[0].getBoundingClientRect().left + circle2[0].getBoundingClientRect().width / 2;
                    const y2Pos = circle2[0].getBoundingClientRect().top + circle2[0].getBoundingClientRect().height / 2;

                    createLine(x1Pos, y1Pos, x2Pos, y2Pos, circle1.attr('id'), circle2.attr('id'));
                });
   
            } //end load from local storage

            //CONTROL DRAG DUPLICATES

          
    

    //remove the saved data when clicked
        document.querySelector('#deleteSave').addEventListener('click', function () {

            if (confirm("Are you sure you want to delete your notes from storage?")) {
                //code for deleting
                localStorage.removeItem('mindMapperData');
                window.location.reload();


            } else {
                //just cancel
            }


        })

        //a helper function that returns all lines connected to the passed in circle

        function getConnectedLines(circle){

           let theLines = $(`.line[data-circle1="${$(circle).attr('id')}"],.line[data-circle2="${$(circle).attr('id')}"]`);

           return theLines;
        }

        //DELETE THE SELECTED CIRCLES WHEN PRESSING DELETE

          $(document).keydown(function (event) {
                if (event.key === 'Delete' || event.keyCode === 46) {

                    let linesToDelete;
                    $('.selected').each(function(){
                        linesToDelete = getConnectedLines(this);

                        if (linesToDelete) {
                            linesToDelete.remove();
                        }

                        this.remove();

                    })

                    chek = linesToDelete;

                    

                    saveToLocalStorage();


                }  

            })

            //more generic delete function
            function deleteElement(myElem){

                linesToDelete = getConnectedLines(myElem);

                        if (linesToDelete) {
                            linesToDelete.remove();
                        }

                        myElem.remove();

                        saveToLocalStorage();

            }


            

        //enable or disable eraser brush
            $('#eraser').on('click', function () {
                eraseMode = !eraseMode; //toggle boolean

                changeMode();

            })

            //enable or disable clone brush
                $('#clonebrush').on('click', function () {
                    cloneMode = !cloneMode; //toggle boolean

                    changeMode();

                })


            function changeMode(){

                //when erasemode mode is on:
                if (eraseMode) {
                    $('body').css('cursor', 'url(iconmonstr-eraser-1-48.png) 16 32, auto');
                } else {
                    $('body').css('cursor', 'unset');
                }

                //when cloneMode mode is on:
                if (cloneMode) {
                    $('body').css('cursor', 'url(iconmonstr-paintbrush-3-64.png) 16 32, auto');
                } else {
                    $('body').css('cursor', 'unset');
                }

            }

        /* 
        
        -control drag to clone a circle

        -make an object variable from the draggable settings, since they are getting quite complex and annoying to maintain

        -delete save button for local storage

        -new getConnectedLines function to make getting lines nicer

        -deleting selected circles (and the lines connected to them) when pressing delete

        -extend delete functionality to a delete tool as well
        
        -change font size (and store that also in local storage)

        -clone brush to clone settings

        -canvas drag and zoom

        -file save system

        -undo system (complicated)
            *Handle: create new circles, change text, move circle, delete a circle (needs to store all deleted circle features, including the text inside)

        
        */
           

    </script>
    
</body>
</html>