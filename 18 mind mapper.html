<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body{
            min-height: 90vh;
        }

        .circle{
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: crimson;
            position: absolute;
            box-sizing: border-box;
            box-shadow: #0000005c 2px 2px 10px;
        }

        div#header {
            display: grid;
            grid-template-columns: 3fr repeat(9, 1fr);
            background-color: white;
            box-shadow: 1px 1px 10px black;
        }

        .uiElem {
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .plusButton {
            font-size: 4rem;
            font-weight: bolder;
            background-color: darkgrey;
            width: 5rem;
            height: 5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-left: 1rem;
        }

        .selected{
            border: 3px dashed darkblue;
        }

       .circle {
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
}


.textareawrap {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 90%;
    height: 90%;
}

.line {
    height: 3px;
    background-color: chocolate;
    transform-origin: 0 100%;
}

/* Button styles */

.button {
    appearance: button;
    background-color: #1899D6;
    border: solid transparent;
    border-radius: 16px;
    border-width: 0 0 4px;
    box-sizing: border-box;
    color: #FFFFFF;
    cursor: pointer;
    display: block;
    font-family: din-round,sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: .8px;
    line-height: 20px;
    margin: 0;
    outline: none;
    overflow: visible;
    padding: 10px 13px;
    text-align: center;
    text-transform: uppercase;
    touch-action: manipulation;
    transform: translateZ(0);
    transition: filter .2s;
    user-select: none;
    -webkit-user-select: none;
    white-space: nowrap;
}

.button:after {
  background-clip: padding-box;
  background-color: #1CB0F6;
  border: solid transparent;
  border-radius: 16px;
  border-width: 0 0 4px;
  bottom: -4px;
  content: "";
  left: 0;
  position: absolute;
  right: 0;
  top: 0;
  z-index: -1;
}

.button:main,
.button:focus {
  user-select: auto;
}

.button:hover:not(:disabled) {
  filter: brightness(1.1);
  -webkit-filter: brightness(1.1);
}

.button:disabled {
  cursor: auto;
}

    </style>

    <link rel="stylesheet" href="jquery-ui.css">
</head>
<body>

    <div id="header">
        <div class="uiElem"><h1>Mind Mapper</h1></div>
        <div class="uiElem"><div class="plusButton">+</div></div>
        <div class="uiElem"><input type="color" id="color"></div>
        <div class="uiElem"><input type="range" min="50" max="1500" value="200" id="circlesize"></div>
        <div class="uiElem"></div>
        <div class="uiElem"></div>
        <div class="uiElem"></div>
        <div class="uiElem"></div>
        <div class="uiElem"></div>
        <div class="uiElem"><button id="deleteSave" class="button">Delete Save</button></div>
 
    </div>

    <div class="circle" id="c0">
        <div class="textareawrap">
            <div class="textarea" contenteditable="false">Change Me</div>
        </div>
    </div>

    <script src="jquery-3.6.3.js"></script>
    <script src="jquery-ui.min.js"></script>

    <script>

        /*
        TO DO LIST:
        -Would be nice to control drag circles to duplicate them with the same properties that they already have and also connecting to the same nodes
        -deleting localstorage saves
        -delete circles with an eraser tool and or by selecting it and hitting delete
        -saving and opening files
        -sizing also the texts
        -undo and redo
        X remove all selections when clicking on an empty spot
        
        */

    let newCircleID = 1;

    //LET'S CREATE A NAMED OBJECT FOR ALL THE DRAGGABLE SETTINGS TO AVOID REPETITION

        const draggableOptions = {
            start: function (event, ui){ //this method is triggered when the dragging starts
                if (event.ctrlKey){
                    $(this).addClass('cloned'); //add a class to the dragged elements
                    $(this).data('cloned', $(this).clone().removeClass('cloned'));
                    $(this).data('originalCircle', $(this).attr('id')); // store the id of the original circle
                    
                } else {
                    $(this).removeClass('cloned');
                }
            },
            drag: function (event, ui) { //this happens all the time when the element is being dragged
                updateLines(this);
            },
            stop: function (event, ui) { //when the dragging stops
                if ($(this).hasClass('cloned')){
                    let cloned = $(this).data('cloned');
                    $('body').append(cloned);
                }
                saveToLocalStorage();
            }
        }

    $(document).ready(function(){
        loadFromLocalStorage();
    })


    //DETECT DOUBLE CLICKS ON THE TEXTAREA DIV
    $('body').on('dblclick', '.textarea', function(){
        $(this).attr('contenteditable', 'true').focus();

        let myCircle = $(this).closest('.circle');

        if (myCircle.data('ui-draggable')){
             $(myCircle).draggable('destroy');
        }

    })

    //CHEK IF THE TEXT AREA STOPS BEING IN FOCUS
    $('body').on('blur', '.textarea', function(){

        $(this).attr('contenteditable', 'false');
        $(this).closest('.circle').draggable(draggableOptions);

        saveToLocalStorage();
    })

   
    

            

    $('body').on('mousedown', '.textarea', function(event){
        console.log('mousedown on .textarea');
        event.stopPropagation();
    })

    //CREATE A NEW CIRCLE BY CLICKING ON THE PLUS BUTTON:

      $('.plusButton').click(function(){
        let myNewCircle = $('<div class="circle"><div class="textareawrap"><div class="textarea" contenteditable="false">Change Me</div></div ></div>');
        myNewCircle.attr('id', 'c'+ newCircleID);
        newCircleID++; //grow the variable by one every time a circle is created
         $(myNewCircle).animate({
              width: '20vw',
              height: '20vw'
          }, 2000);
        $('body').append(myNewCircle);
         $(myNewCircle).draggable(draggableOptions);
         saveToLocalStorage();
      })
       

        $('.circle').animate({
            width: '20vw',
            height: '20vw'
        },2000);

        $('.circle').draggable(draggableOptions);


        
       
       //ADD OR REMOVE THE SELECTED CLASS OF A CIRCLE WHEN ITS CLICKED
        $('body').on('click', '.circle', function(){
            $(this).toggleClass('selected');
        });

        //remove selection from circles if just the body was clicked
        $('body').click(function(e){
            if ($(e.target).is('body')){
                console.log('should remove selections now');
                 $('.circle').removeClass('selected');
            }
        })

        //DETECT A SHIFT CLICK

        $('body').on('mouseup', '.circle', function(event){

            if (event.shiftKey){
                console.log('you clicked on a circle while holding down shift');
                let selectedCircle = $('.selected');

                let selectedCircleID = selectedCircle.attr('id');
                let clickedCircleID = $(this).attr('id');

                console.log('selectedCircleID ' + selectedCircleID + ' clickedCircleID ' + clickedCircleID);

                let selectedCircleWidth = selectedCircle[0].getBoundingClientRect().width;
                let clickedCircleWidth = $(this)[0].getBoundingClientRect().width;

                let x1pos = selectedCircle[0].getBoundingClientRect().left + selectedCircleWidth/2; //[0] take the first element from the jQuery object and then get it's x coordinate
                let y1pos = selectedCircle[0].getBoundingClientRect().top + clickedCircleWidth/2;
                let x2pos = $(this)[0].getBoundingClientRect().left + clickedCircleWidth/2;
                let y2pos = $(this)[0].getBoundingClientRect().top + clickedCircleWidth / 2;

                console.log('creating a line now, this is: ' + this);

                createLine(x1pos, y1pos, x2pos, y2pos, selectedCircleID, clickedCircleID);
                saveToLocalStorage();

            }

        })
 
            //CREATE A LINE BETWEEN TWO ELEMENTS (FOUR COORDINATES):
            function createLine(x1, y1, x2, y2, selectedCircleID, clickedCircleID){

                let length = Math.sqrt(((x1 - x2) * (x1 - x2)) + ((y1 - y2) * (y1 - y2)));
                let angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                let transform = 'rotate(' + angle + 'deg)';

                offsetX = (x1 > x2) ? x2 : x1;
                offsetY = (y1 > y2) ? y2 : y1;

                let line = $('<div>')
                            .prependTo('body')
                            .addClass('line')
                            .css({
                                'position': 'absolute',
                                'transform': transform
                            })
                            .width(length)
                            .offset({
                                left: offsetX,
                                top: offsetY
                            })
                            .attr("data-circle1", selectedCircleID)
                            .attr("data-circle2", clickedCircleID)


            }

            //UPDATE THE LINES WHEN A CIRCLE IS MOVED

            function updateLines(circle){

                let allConnectedLines = $(`.line[data-circle1="${$(circle).attr('id')}"],.line[data-circle2="${$(circle).attr('id')}"]`);

                allConnectedLines.each(function (index, line){

                    let lineCircleConnect1 = $(line).data('circle1'); //get the circle ids from the lines
                    let lineCircleConnect2 = $(line).data('circle2');

                    let circle1 = $('#' + lineCircleConnect1); //select the circle from dom
                    let circle2 = $('#' + lineCircleConnect2); //select the circle from dom

                    let x1Pos = circle1[0].getBoundingClientRect().left + circle1[0].getBoundingClientRect().width / 2;
                    let y1Pos = circle1[0].getBoundingClientRect().top + circle1[0].getBoundingClientRect().height / 2;
                    let x2Pos = circle2[0].getBoundingClientRect().left + circle2[0].getBoundingClientRect().width / 2;
                    let y2Pos = circle2[0].getBoundingClientRect().top + circle2[0].getBoundingClientRect().height / 2;

                    $(this).remove();

                    createLine(x1Pos, y1Pos, x2Pos, y2Pos, circle1.attr('id'), circle2.attr('id'));

                })
            } //update lines


            //CHANGE THE COLOR OF THE SELECTED CIRCLES

            $('body').on('input', '#color', function(){
                //console.log($(this).val());

                $('.selected').css("background-color", $(this).val());
                saveToLocalStorage();

            })
            
            //CHANGE THE SIZE OF THE CIRCLES

            $("#circlesize").on('change input', function(){
                const scaleValueFromSlider = $(this).val();
                //console.log('scaleValueFromSlider: ' + scaleValueFromSlider);
                $('.selected').each(function() {

                    const currentWidth = $(this).outerWidth();
                    //console.log(currentWidth);
                    $(this).css({'width': scaleValueFromSlider, 'height': scaleValueFromSlider});

                    const currentPosition = $(this).position();

                    let newX = currentPosition.left - (scaleValueFromSlider - currentWidth) / 2;
                    let newY = currentPosition.top - (scaleValueFromSlider - currentWidth) / 2;

                    $(this).css({left: newX, top: newY});
                   



                })
                saveToLocalStorage();
            })

            //GET THE NECESSARY DATA FROM EVERY ELEMENT OF THE MIND MAP
            function extractData(){

                //loop through each circle and push the needed info as an object into an array
                const circlesData = [];
                
                $('.circle').each(function(){
                        const circleID = $(this).attr('id');
                        const circleText = $(this).find('.textarea').text();
                        const circleColor = $(this).css('background-color');
                        const circlePos = $(this).position();
                        const circleWidth = $(this).width();
                        circlesData.push({
                            id: circleID,
                            text: circleText,
                            color: circleColor,
                            position: circlePos,
                            width: circleWidth
                        })

                }) //end circle each

                //loop through each line
                const linesData = [];
                $('.line').each(function(){
                    const lineData = {
                        circle1: $(this).data('circle1'),
                        circle2: $(this).data('circle2')
                    };

                    linesData.push(lineData);

                });

                return {
                    circles: circlesData,
                    lines: linesData
                }

            } //end extract data

            //SAVE TO STORAGE:
            function saveToLocalStorage(){
                console.log('Should store to local storage now');
                const myData = extractData(); //store the return value of extractData into a variable called myData
                const jsonData = JSON.stringify(myData);
                localStorage.setItem('mindMapperData', jsonData);
                localStorage.setItem('latestID', newCircleID);
            }

            //GET THE CIRCLES AND LINES BACK FROM LOCAL STORAGE

            function loadFromLocalStorage(){
                const jsonData = localStorage.getItem('mindMapperData');
                if (!jsonData) return; //quit/exit the function early if there is no data yet

                const theLatestID = localStorage.getItem('latestID');
                if (!theLatestID) return;

                newCircleID = theLatestID;


                const myData = JSON.parse(jsonData);

                //Clear existing elements
                $('.circle').remove();
                $('.line').remove();

                myData.circles.forEach(circleData => {
                    //create a new html element for each circle
                    const circle = $(`
                    <div class="circle">
                        <div class="textareawrap">
                             <div class="textarea" contenteditable="false">Change Me</div>
                        </div>
                    </div>
                    `);

                    circle.attr('id', circleData.id);
                    circle.find('.textarea').text(circleData.text);
                    circle.css('background-color', circleData.color);
                    circle.css('left', circleData.position.left + 'px');
                    circle.css('top', circleData.position.top + 'px');
                    circle.width(circleData.width);
                    circle.height(circleData.width);
                    $('body').append(circle);
                    $(circle).draggable(draggableOptions);
                }) //end circles for each

                // Recreate lines
                myData.lines.forEach(lineData => {
                    const circle1 = $('#' + lineData.circle1);
                    const circle2 = $('#' + lineData.circle2);

                    const x1Pos = circle1[0].getBoundingClientRect().left + circle1[0].getBoundingClientRect().width / 2;
                    const y1Pos = circle1[0].getBoundingClientRect().top + circle1[0].getBoundingClientRect().height / 2;
                    const x2Pos = circle2[0].getBoundingClientRect().left + circle2[0].getBoundingClientRect().width / 2;
                    const y2Pos = circle2[0].getBoundingClientRect().top + circle2[0].getBoundingClientRect().height / 2;

                    createLine(x1Pos, y1Pos, x2Pos, y2Pos, circle1.attr('id'), circle2.attr('id'));
                });
   
            } //end load from local storage

            //DELETE LOCAL STORAGE SAVE

            $('#deleteSave').click(()=>{
                if (confirm("Are you sure you want to delete your saved mind map from storage?")){
                    localStorage.removeItem('mindMapperData');
                    localStorage.removeItem('latestID');
                    window.location.reload(); //refresh the page

                }
            });

            //CONTROL DRAG TO CLONE A CIRCLE



    </script>
    
</body>
</html>